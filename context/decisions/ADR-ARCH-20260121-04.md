# ADR-ARCH-20260121-04: APIs REST con Prisma Direct + BD Persistence

**ID:** `ADR-ARCH-20260121-04`  
**T√≠tulo:** Arquitectura de APIs REST para Flujo E2E Demo  
**Fecha:** 21 de enero de 2026  
**Estado:** ‚úÖ ACEPTADO  
**Impacto:** HIGH - Cambio fundamental de persistencia  
**Contexto Metodol√≥gico:** INTEGRA v2.1.1

---

## üìã PROBLEMA

**Situaci√≥n Inicial:**
- Sistema de demo exist√≠a con componentes React pero **sin persistencia a BD**
- Componentes ejecutaban l√≥gica pero solo hac√≠an `console.log()`
- No hab√≠a forma de guardar datos entre sesiones
- Necesidad urgente: Entregar demo FUNCIONAL Thursday 23/01

**Pregunta Clave:** ¬øC√≥mo implementar persistencia m√≠nima sin comprometer simplicidad de demo?

---

## üéØ OBJETIVOS

1. **Funcionalidad:** Sistema debe guardar datos reales en BD
2. **Rapidez:** Implementaci√≥n en < 4 horas
3. **Escalabilidad:** Dise√±o debe permitir refactorizaci√≥n post-demo
4. **Mantenibilidad:** C√≥digo limpio, sin deuda t√©cnica bloqueante
5. **Sencillez:** No agregar complejidad innecesaria para Fase 0.5

---

## üèóÔ∏è DECISI√ìN

### Arquitectura Seleccionada: "APIs REST + Prisma Direct + JSON Fields"

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CLIENTE (React Components)                      ‚îÇ
‚îÇ ‚îî‚îÄ fetch('/api/...', { method: 'POST' })        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ APIs (Next.js Routes)                           ‚îÇ
‚îÇ ‚îî‚îÄ /api/papeletas, /exams, /doctors, /deliveries
‚îÇ ‚îî‚îÄ Validaci√≥n + Prisma queries (DIRECT)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ORM: Prisma v6.19.1                             ‚îÇ
‚îÇ ‚îî‚îÄ Schema-driven, type-safe queries              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Database: PostgreSQL                            ‚îÇ
‚îÇ ‚îî‚îÄ Cloud (Railway) o Local (PgAdmin)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ¬øPor qu√© Direct Prisma (sin service layer)?

| Alternativa | Pros | Contras | ‚≠ê |
|-------------|------|---------|-----|
| **Direct Prisma** | Simple, r√°pido, debuggeable | Menos reutilizable | ‚úÖ ELEGIDA |
| Service Layer | Reutilizable, testeable | Extra indirection | ‚ùå Pospuesta |
| GraphQL | Flexible, powerful | Complejidad extra | ‚ùå Descartada |
| tRPC | Type-safe | Setup extra | ‚ùå Descartada |

**Justificaci√≥n de elecci√≥n:**
- ‚úÖ Demo necesita VELOCIDAD, no arquitectura perfecta
- ‚úÖ Service layer agregable en Fase 1 sin breaking changes
- ‚úÖ Prisma client ya est√° configurado
- ‚úÖ Type-safe sin extra boilerplate

---

## üîç CONSECUENCIAS

### Positivas ‚úÖ

1. **Implementaci√≥n R√°pida**
   - Directo: Query ‚Üí Response ‚Üí Persistencia
   - No hay indirecci√≥n de capas
   - Equipo puede ver cambios inmediatamente

2. **Debugging F√°cil**
   - Stack trace directo: API Route ‚Üí Prisma ‚Üí BD
   - Logs claros sin abstracciones
   - Error messages √∫tiles

3. **Type Safety**
   - Prisma genera tipos autom√°ticamente
   - TypeScript previene errores en compile time
   - IDE autocompletion funciona perfecto

4. **Escalable Horizontalmente**
   - Cada endpoint es independiente
   - F√°cil de paralelizar tareas futuras
   - Service layer se puede agregar gradualmente

### Negativas ‚ö†Ô∏è

1. **Repetici√≥n de C√≥digo**
   - Validaciones duplicadas en m√∫ltiples endpoints
   - Queries simples esparcidas en archivos
   - **Mitigaci√≥n:** Extraer en utils durante Fase 1

2. **Menos Reutilizable (Por Ahora)**
   - Logic est√° en routes, no compartible
   - Dif√≠cil testear queries en aislamiento
   - **Mitigaci√≥n:** Tests E2E en Fase 1 son suficientes

3. **Acoplamiento Frontend-API**
   - Cambios de API requieren cambios en componentes
   - **Mitigaci√≥n:** Versioning de API en Fase 1

4. **Deuda T√©cnica**
   - Refactorizaci√≥n obligatoria post-demo
   - **Mitigaci√≥n:** Documentado en roadmap

---

## üîß IMPLEMENTACI√ìN DETALLES

### Patr√≥n de API Route

```typescript
// POST /api/{resource}/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

interface RequestBody {
  // Campos del recurso
  tenantId: string;
  // ...
}

export async function POST(req: NextRequest) {
  try {
    // 1. Parse
    const body: RequestBody = await req.json();

    // 2. Validaci√≥n
    if (!body.field) {
      return NextResponse.json({ error: 'field required' }, { status: 400 });
    }

    // 3. DB Operation
    const result = await prisma.resource.create({
      data: {
        ...body,
      },
    });

    // 4. Response
    return NextResponse.json(
      { success: true, data: result },
      { status: 201 }
    );
  } catch (error) {
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    );
  }
}
```

### Patr√≥n de Component Integration

```typescript
// En componente React
const handleSubmit = async (data) => {
  const res = await fetch('/api/resource', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });

  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error);
  }

  return await res.json();
};
```

### Modelos Prisma Utilizados

```prisma
model Expedient {
  id       String    @id @default(cuid())
  tenantId String
  clinicId String
  folio    String    @unique
  status   String    // RECEPTION, EXAMINATION_COMPLETE, DELIVERED
  // ...
}

model MedicalExam {
  id         String @id @default(cuid())
  expedientId String
  examData   Json   // 6 secciones en un JSON field
  approved   Boolean
  // ...
}

model Doctor {
  id           String @id @default(cuid())
  clinicId     String
  cedula       String
  name         String
  specialty    String
  signatureUrl String?
  @@unique([cedula, clinicId])  // Validaci√≥n de unicidad
}
```

---

## üìä ALTERNATIVAS CONSIDERADAS

### Opci√≥n A: Guardar en localStorage (RECHAZADA)
```javascript
// ‚ùå No: Solo demo local, sin compartir entre usuarios
localStorage.setItem('expedient', JSON.stringify(data));
```

### Opci√≥n B: GraphQL con Apollo (RECHAZADA)
```typescript
// ‚ùå No: Extra complejidad, schema resolvers, demasiado para demo
// Aplica mejor en Fase 2 cuando hay m√∫ltiples clientes
```

### Opci√≥n C: Firebase Realtime (RECHAZADA)
```typescript
// ‚ùå No: Ya tenemos PostgreSQL + Prisma, no necesitamos otra BD
// Migraci√≥n innecesaria de datos
```

### Opci√≥n D: Service Layer desde inicio (RECHAZADA)
```typescript
// ‚ùå No: Ralentizar√≠a demo en +2 horas
// Agregable f√°cilmente despu√©s
```

**‚úÖ OPCI√ìN ELEGIDA: Direct Prisma**
- ‚úÖ R√°pido + Funcional + Escalable

---

## üîê TRADE-OFFS ACEPTADOS

| Trade-off | Raz√≥n | Plan |
|-----------|-------|------|
| Sin tests | Demo urgente | Agregar en Fase 1 |
| Sin auth | Demo simple | Agregar en Fase 1 |
| Sin service layer | Velocidad | Refactorizar en Fase 1 |
| Validation duplicada | Simplicidad | Extraer en Fase 1 |

---

## üìà M√âTRICAS DE √âXITO

- ‚úÖ APIs retornan datos correctos (TEST MANUAL PASSED)
- ‚úÖ Datos persisten en BD (QUERY VERIFIED)
- ‚úÖ Build compila sin errores (TURBOREPO 15/15)
- ‚úÖ Demo funcional Thursday 23/01 (OBJETIVO)

---

## üîÑ VERSI√ìN FUTURA (POST-DEMO)

### Fase 1: Refactorizaci√≥n

```typescript
// Extraer service layer
// src/services/expedient.service.ts
export const createExpedient = async (data) => {
  // L√≥gica compartible
  return await prisma.expedient.create({ data });
};

// Reutilizable en:
// - API routes
// - Server actions
// - Direct calls
```

### Fase 2: GraphQL

```graphql
# Soportar m√∫ltiples clientes
type Query {
  expedient(id: ID!): Expedient
  expedients(tenantId: ID!): [Expedient]
}

type Mutation {
  createExpedient(...): Expedient
  createMedicalExam(...): MedicalExam
}
```

---

## üìö REFERENCIAS

- Prisma Docs: https://www.prisma.io/docs
- Next.js API Routes: https://nextjs.org/docs/app/building-your-application/routing/route-handlers
- INTEGRA Methodology: `/workspaces/AMI-SYSTEM/.github/instructions/GLOBAL INSTRUCTIONS.instructions.md`

---

## ‚úÖ APROBACI√ìN

| Rol | Aprob√≥ | Fecha |
|-----|--------|-------|
| Constructor (SOFIA) | ‚úÖ | 2026-01-21 |
| Lead Debugger (Deby) | ‚è≥ | Pending |
| QA/Architect (GEMINI) | ‚è≥ | Pending |

---

## üìù REVISIONES FUTURAS

- [ ] Agregar Service Layer (Fase 1)
- [ ] Implementar Tests (Fase 1)
- [ ] Migrar a GraphQL (Fase 2)
- [ ] Optimizar DB Indexes (Fase 1.5)

---

**Construido bajo:** INTEGRA v2.1.1  
**Constructor:** SOFIA - Builder  
**Timestamp:** 2026-01-21 14:40 UTC
