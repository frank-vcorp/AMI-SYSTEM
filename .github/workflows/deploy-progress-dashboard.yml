# ============================================================================
# GITHUB ACTION: Deploy Progress Dashboard
# ============================================================================
# Actualiza automÃ¡ticamente el dashboard de progreso cada vez que se modifica
# PROYECTO.md en la rama master.
#
# FLUJO:
# 1. Detecta cambios en PROYECTO.md
# 2. Ejecuta parser.js para generar project_data.json
# 3. Hace commit del JSON actualizado
# 4. El webhook de Plesk en vcorp.mx detecta el push y hace git pull
#
# NOTA: El servidor tiene configurado un webhook que sincroniza automÃ¡ticamente
# con el repo. NO se usa FTP.
# ============================================================================

name: Deploy Progress Dashboard

on:
  push:
    branches:
      - master
    paths:
      - 'PROYECTO.md'
      - 'progressdashboard/**'
  
  # Permite ejecuciÃ³n manual desde la UI de GitHub
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“Š Generar project_data.json
        run: |
          echo "Ejecutando parser..."
          node progressdashboard/parser.js
          echo "âœ… JSON generado correctamente"
          
          if [ -f progressdashboard/data/project_data.json ]; then
            echo "ðŸ“ˆ Progreso general: $(jq -r '.overallProgress' progressdashboard/data/project_data.json)%"
            echo "ðŸ“¦ Fases: $(jq -r '.phases | length' progressdashboard/data/project_data.json)"
          fi

      - name: ðŸ’¾ Commit datos actualizados
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(dashboard): Auto-update progress data'
          file_pattern: 'progressdashboard/data/project_data.json'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'
