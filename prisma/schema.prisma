// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MOD-CLINICAS: Clinic Management Models
// ============================================================================

model Clinic {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  name              String            @db.VarChar(255)
  description       String?           @db.Text
  address           String            @db.VarChar(255)
  city              String            @db.VarChar(100)
  state             String            @db.VarChar(100)
  zipCode           String            @db.VarChar(10)
  phoneNumber       String?           @db.VarChar(20)
  email             String?           @db.VarChar(255)
  totalBeds         Int               @default(1)
  availableBeds     Int               @default(1)
  isHeadquarters    Boolean           @default(false)
  status            ClinicStatus      @default(ACTIVE)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  schedules         ClinicSchedule[]
  services          ClinicService[]
  appointments      Appointment[]
  expedients        Expedient[]
  doctors           Doctor[]

  // Indices
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([status])
  @@index([city])
  @@map("clinics")
}

model ClinicSchedule {
  id                String            @id @default(cuid())
  clinicId          String
  dayOfWeek         Int               @db.SmallInt // 0-6: Monday-Sunday
  openingTime       String            @db.VarChar(5) // HH:MM format
  closingTime       String            @db.VarChar(5) // HH:MM format
  lunchStart        String?           @db.VarChar(5)
  lunchEnd          String?           @db.VarChar(5)
  isOpen            Boolean           @default(true)
  maxAppointmentsDay Int              @default(50)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  clinic            Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  // Indices
  @@unique([clinicId, dayOfWeek])
  @@index([clinicId])
  @@map("clinic_schedules")
}

model ClinicService {
  id                String            @id @default(cuid())
  clinicId          String
  serviceId         String
  isAvailable       Boolean           @default(true)
  estimatedDays     Int?
  price             Float?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  clinic            Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Indices
  @@unique([clinicId, serviceId])
  @@index([clinicId])
  @@index([serviceId])
  @@map("clinic_services")
}

model Appointment {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  clinicId          String
  companyId         String?
  patientId         String
  displayId         String?           // Generated: APT-XXXXXX for display
  appointmentDate   DateTime
  time              String            @db.VarChar(5) // HH:MM format
  appointmentDuration Int?            // Minutes allocated for appointment
  status            AppointmentStatus @default(PENDING)
  notes             String?           @db.Text
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  clinic            Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient           Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  expedients        Expedient[]

  // Indices
  @@index([tenantId])
  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([appointmentDate])
  @@unique([displayId])
  @@map("appointments")
}

model Doctor {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  clinicId          String
  name              String            @db.VarChar(255)
  cedula            String            @db.VarChar(20)
  specialty         String            @db.VarChar(100)
  signature         Json?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  clinic            Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  validationTasks   ValidationTask[]   @relation("ValidationSignedBy")

  // Indices
  @@unique([tenantId, cedula])
  @@index([tenantId])
  @@index([clinicId])
  @@map("doctors")
}

enum ClinicStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum AppointmentStatus {
  PENDING
  SCHEDULED
  CONFIRMED
  CHECK_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============================================================================
// MOD-SERVICIOS: Service & Battery Management Models
// ============================================================================

model Service {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  code              String            @db.VarChar(50)
  name              String            @db.VarChar(255)
  description       String?           @db.Text
  category          ServiceCategory   @default(OTROS)
  estimatedMinutes  Int               @default(30)
  requiresEquipment Boolean           @default(false)
  equipmentName     String?           @db.VarChar(255)
  costAmount        Float             @default(0)
  sellingPrice      Float?
  status            ServiceStatus     @default(ACTIVE)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?           @db.Uuid
  updatedBy         String?           @db.Uuid

  // Relations
  batteries         BatteryService[]
  clinics           ClinicService[]

  // Indices
  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@index([category])
  @@map("services")
}

model Battery {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  name              String            @db.VarChar(255)
  description       String?           @db.Text
  costTotal         Float             @default(0)
  sellingPriceTotal Float?
  estimatedMinutes  Int               @default(0)
  status            BatteryStatus     @default(ACTIVE)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?           @db.Uuid
  updatedBy         String?           @db.Uuid

  // Relations
  services          BatteryService[]
  contractedBatteries CompanyBattery[]

  // Indices
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([status])
  @@map("batteries")
}

model BatteryService {
  id                String            @id @default(cuid())
  batteryId         String
  serviceId         String
  order             Int               @default(0)
  costOverride      Float?
  estimatedMinutesOverride Int?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  battery           Battery           @relation(fields: [batteryId], references: [id], onDelete: Cascade)
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Indices
  @@unique([batteryId, serviceId])
  @@index([batteryId])
  @@index([serviceId])
  @@map("battery_services")
}

enum ServiceCategory {
  LABORATORIO
  IMAGENES
  ELECTROCARDIOGRAFIA
  OFTALMOLOGIA
  AUDIOMETRIA
  ESPIROFOTOMETRIA
  OTROS
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  DEPRECATED
  ARCHIVED
}

enum BatteryStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

// ============================================================================
// MOD-EMPRESAS: Company & JobProfile Management Models
// ============================================================================

model Company {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  name              String            @db.VarChar(255)
  rfc               String            @db.VarChar(13) @unique // Globally unique
  description       String?           @db.Text
  address           String?           @db.VarChar(255)
  city              String?           @db.VarChar(100)
  state             String?           @db.VarChar(100)
  zipCode           String?           @db.VarChar(10)
  phoneNumber       String?           @db.VarChar(20)
  email             String?           @db.VarChar(255)
  contactPerson     String?           @db.VarChar(255)
  contactPhone      String?           @db.VarChar(20)
  isHeadquarters    Boolean           @default(true)
  maxEmployees      Int               @default(100)
  status            CompanyStatus     @default(ACTIVE)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?           @db.Uuid
  updatedBy         String?           @db.Uuid

  // Relations
  batteries         CompanyBattery[]
  jobProfiles       JobProfile[]
  patients          Patient[]

  // Indices
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([status])
  @@map("companies")
}

model CompanyBattery {
  id                String            @id @default(cuid())
  companyId         String
  batteryId         String
  contractDate      DateTime          @default(now())
  validFrom         DateTime          @default(now())
  validUntil        DateTime?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  battery           Battery           @relation(fields: [batteryId], references: [id], onDelete: Cascade)

  // Indices
  @@unique([companyId, batteryId])
  @@index([companyId])
  @@index([batteryId])
  @@map("company_batteries")
}

model JobProfile {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  companyId         String
  name              String            @db.VarChar(255)
  description       String?           @db.Text
  riskLevel         RiskLevel         @default(BAJO)
  requiredBatteryIds String[]          // JSON array of battery IDs
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?           @db.Uuid
  updatedBy         String?           @db.Uuid

  // Relations
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Indices
  @@unique([companyId, name])
  @@index([tenantId])
  @@index([companyId])
  @@map("job_profiles")
}

enum RiskLevel {
  BAJO
  MEDIO
  ALTO
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  ARCHIVED
}

// ============================================================================
// MOD-EXPEDIENTES: Patient Expedient Models
// ============================================================================

model Expedient {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  appointmentId     String?
  patientId         String
  clinicId          String
  folio             String            @unique // Generated format: EXP-CLINIC-DATE-SEQ
  status            ExpedientStatus   @default(PENDING)
  
  // Vital signs capture
  vitals            Json?             // {sistolica, diastolica, fc, temp, o2, imc}
  medicalNotes      String?           @db.Text
  
  // Study uploads
  studies           Study[]
  medicalExams      MedicalExam[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  appointment       Appointment?      @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  patient           Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinic            Clinic            @relation(fields: [clinicId], references: [id])
  validationTask    ValidationTask?

  // Indices
  @@index([tenantId])
  @@index([patientId])
  @@index([clinicId])
  @@index([status])
  @@map("expedients")
}

model Patient {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  name              String            @db.VarChar(255)
  documentType      String            @default("DNI") // DNI, Pasaporte, etc
  documentNumber    String
  dateOfBirth       DateTime
  gender            String            @default("M") // M, F, O
  phoneNumber       String?           @db.VarChar(20)
  email             String?           @db.VarChar(255)
  address           String?           @db.Text
  city              String?           @db.VarChar(100)
  state             String?           @db.VarChar(100)
  zipCode           String?           @db.VarChar(10)
  companyId         String?           // Current employer
  status            PatientStatus     @default(ACTIVE)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  company           Company?          @relation(fields: [companyId], references: [id], onDelete: SetNull)
  appointments      Appointment[]
  expedients        Expedient[]

  // Indices
  @@unique([tenantId, documentNumber])
  @@index([tenantId])
  @@index([companyId])
  @@map("patients")
}

model Study {
  id                String            @id @default(cuid())
  expedientId       String
  fileKey           String            // GCS storage key
  fileName          String
  studyType         StudyType
  uploadedAt        DateTime          @default(now())
  fileSize          Int?              // Bytes
  mimeType          String?
  
  createdAt         DateTime          @default(now())

  // Relations
  expedient         Expedient         @relation(fields: [expedientId], references: [id], onDelete: Cascade)

  // Indices
  @@index([expedientId])
  @@index([studyType])
  @@map("studies")
}

model MedicalExam {
  id                String            @id @default(cuid())
  expedientId       String
  
  // Vital signs
  bloodPressure     String?           // SYS/DIA format
  heartRate         Int?              // bpm
  respiratoryRate   Int?              // breaths/min
  temperature       Float?            // Celsius
  weight            Float?            // kg
  height            Int?              // cm
  
  // Calculated metrics
  imc               Float?            // Index of Body Mass (calculated: weight / (height/100)^2)
  
  // Vision assessment
  leftEyeAcuity     Float?            // OD (derecho) - 6/6, 6/9, etc
  rightEyeAcuity    Float?            // OI (izquierdo) - 6/6, 6/9, etc
  colorBlindnessTest Boolean?         // Daltonismo result
  
  // Medical history
  surgeries         Json?             // Array of {date, description, notes}
  medications       Json?             // Array of {name, dosage, frequency, indication}
  allergies         Json?             // Array of {allergen, severity, notes}
  
  // Physical and clinical examination
  physicalExam      String?           @db.Text
  notes             String?           @db.Text
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  expedient         Expedient         @relation(fields: [expedientId], references: [id], onDelete: Cascade)

  // Indices
  @@index([expedientId])
  @@map("medical_exams")
}

enum StudyType {
  RADIOGRAFIA
  LABORATORIO
  ECG
  ESPIROMETRIA
  AUDIOMETRIA
  OTROS
}

enum ExpedientStatus {
  PENDING           // Citado, no ha llegado
  IN_PROGRESS       // Cheg√≥, examen en curso
  STUDIES_PENDING   // Esperando estudios
  VALIDATED         // Listo para reporte
  COMPLETED         // Reporte generado
  ARCHIVED
}

enum PatientStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

// ============================================================================
// MOD-VALIDACION: Validation & Dictamen Models
// ============================================================================

model ValidationTask {
  id                String            @id @default(cuid())
  tenantId          String            @db.Uuid
  expedientId       String
  patientId         String
  clinicId          String
  status            ValidationStatus  @default(PENDING)
  
  // Studies and extracted data
  studies           Json              // Array of {id, fileKey, fileName, studyType, uploadedAt, extractionStatus}
  extractedData     Json              @default("{}")  // {laboratorio?, radiografia?, ecg?, ...}
  
  // Medical assessment
  medicalOpinion    String            @db.Text @default("")
  verdict           Verdict           @default(APTO)
  restrictions      String[]          @default([])
  recommendations   String[]          @default([])
  
  // Signature and timeline
  signedAt          DateTime?
  signedBy          String?           @db.Uuid // UID of signing physician
  validatedBy       String?           @db.Uuid // UID of validator
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  expedient         Expedient         @relation(fields: [expedientId], references: [id], onDelete: Cascade)
  signedByDoctor    Doctor?           @relation("ValidationSignedBy", fields: [signedBy], references: [id])

  // Indices
  @@unique([expedientId])
  @@index([tenantId])
  @@index([patientId])
  @@index([status])
  @@index([verdict])
  @@map("validation_tasks")
}

enum ValidationStatus {
  PENDING
  IN_REVIEW
  COMPLETED
  SIGNED
  REJECTED
}

enum Verdict {
  APTO
  APTO_CON_RESTRICCIONES
  NO_APTO
}

// ============================================================================
// MOD-CITAS: Extended Appointment Models (from mod-citas context)
// ============================================================================
// Note: The Appointment model above covers basic appointment data.
// This section is reserved for appointment-specific extensions.
