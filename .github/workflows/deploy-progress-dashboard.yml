# ============================================================================
# GITHUB ACTION: Deploy Progress Dashboard
# ============================================================================
# Actualiza autom√°ticamente el dashboard de progreso cada vez que se modifica
# PROYECTO.md en la rama master.
#
# FLUJO:
# 1. Detecta cambios en PROYECTO.md
# 2. Ejecuta parser.js para generar project_data.json
# 3. Hace commit del JSON actualizado
# 4. Sube el dashboard completo a cPanel via FTP
#
# SECRETS REQUERIDOS (configurar en GitHub > Settings > Secrets):
# - CPANEL_FTP_SERVER: servidor FTP (ej: ftp.vcorp.mx)
# - CPANEL_FTP_USERNAME: usuario FTP
# - CPANEL_FTP_PASSWORD: contrase√±a FTP
# - CPANEL_FTP_PATH: ruta remota (ej: /public_html/ami-dashboard/)
# ============================================================================

name: Deploy Progress Dashboard

on:
  push:
    branches:
      - master
    paths:
      - 'PROYECTO.md'
      - 'progressdashboard/**'
  
  # Permite ejecuci√≥n manual desde la UI de GitHub
  workflow_dispatch:

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ========================================
      # 1. CHECKOUT Y SETUP
      # ========================================
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ========================================
      # 2. GENERAR DATOS DEL DASHBOARD
      # ========================================
      - name: üìä Generar project_data.json
        id: generate_data
        run: |
          echo "Ejecutando parser..."
          node progressdashboard/parser.js
          echo "‚úÖ JSON generado correctamente"
          
          # Mostrar resumen
          if [ -f progressdashboard/data/project_data.json ]; then
            echo "üìà Progreso general: $(jq -r '.overallProgress' progressdashboard/data/project_data.json)%"
            echo "üì¶ Fases: $(jq -r '.phases | length' progressdashboard/data/project_data.json)"
          fi

      # ========================================
      # 3. COMMIT AUTOM√ÅTICO SI HAY CAMBIOS
      # ========================================
      - name: üíæ Commit datos actualizados
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(dashboard): Auto-update progress data [skip ci]'
          file_pattern: 'progressdashboard/data/project_data.json'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions Bot <actions@github.com>'

      # ========================================
      # 4. DEPLOY A CPANEL VIA FTP
      # ========================================
      - name: üöÄ Deploy a cPanel (FTP)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: ./progressdashboard/
          server-dir: ${{ secrets.CPANEL_FTP_PATH }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            parser.js
            README.md

      # ========================================
      # 5. NOTIFICACI√ìN (opcional)
      # ========================================
      - name: ‚úÖ Resumen del deploy
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ DASHBOARD DESPLEGADO EXITOSAMENTE"
          echo "=========================================="
          echo "üìÖ Fecha: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üë§ Autor: ${{ github.actor }}"
          echo "=========================================="
