# ADR-ARCH-20260112-03: Modelo de Datos AMI-SYSTEM

**Estado:** Aceptada

**Fecha:** 2026-01-12

**Autores:** INTEGRA (Arquitecto IA)

**Stakeholders:** FRANK (Director), SOFIA (Constructora)

**Etiquetas:** `#database` `#prisma` `#modelo` `#multi-tenant`

---

## Contexto

- **Problema:** Definir el modelo de datos completo que soporte:
  1. Multi-cl√≠nica con capacidades diferentes
  2. Cat√°logo de servicios y bater√≠as (paquetes)
  3. Empresas con contratos y perfiles de puesto
  4. Agenda de citas con disponibilidad
  5. Expedientes m√©dicos con estudios
  6. Sistema de validaci√≥n con sem√°foros
  7. Audit log completo
  8. Multi-tenancy desde el inicio

---

## Decisi√≥n

**Hemos decidido implementar el siguiente modelo de datos:**

---

## Diagrama Entidad-Relaci√≥n

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           MODELO DE DATOS AMI-SYSTEM                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ  TENANT  ‚îÇ
                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                         ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ             ‚îÇ               ‚îÇ               ‚îÇ             ‚îÇ
           ‚ñº             ‚ñº               ‚ñº               ‚ñº             ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ CLINIC ‚îÇ   ‚îÇ SERVICE ‚îÇ    ‚îÇ COMPANY  ‚îÇ   ‚îÇ   USER   ‚îÇ   ‚îÇ BATTERY  ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ             ‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
          ‚îÇ             ‚îÇ              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§              ‚îÇ
          ‚îÇ             ‚îÇ              ‚îÇ              ‚îÇ              ‚îÇ
          ‚îÇ             ‚ñº              ‚ñº              ‚îÇ              ‚îÇ
          ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ      ‚îÇBATTERY_ITEM ‚îÇ ‚îÇJOB_PROFILE‚îÇ       ‚îÇ        ‚îÇCOMPANY_   ‚îÇ
          ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ        ‚îÇBATTERY    ‚îÇ
          ‚îÇ                            ‚îÇ             ‚îÇ        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                            ‚ñº             ‚îÇ
          ‚îÇ                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
          ‚îÇ                      ‚îÇ PATIENT  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                           ‚îÇ
          ‚ñº                           ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇCLINIC_    ‚îÇ              ‚îÇ APPOINTMENT ‚îÇ
    ‚îÇSCHEDULE   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                           ‚îÇ
          ‚ñº                           ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇCLINIC_    ‚îÇ              ‚îÇ EXPEDIENTE  ‚îÇ
    ‚îÇSERVICE    ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇ         ‚îÇ         ‚îÇ
                            ‚ñº         ‚ñº         ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ STUDY  ‚îÇ‚îÇEXAM_   ‚îÇ‚îÇDICTAMEN ‚îÇ
                       ‚îÇ        ‚îÇ‚îÇRESULT  ‚îÇ‚îÇ         ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇEXTRACTED_DATA‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Entidades Detalladas

### 1. TENANT (Multi-tenancy)

```prisma
model Tenant {
  id          String   @id @default(cuid())
  name        String   // "AMI Quer√©taro"
  slug        String   @unique // "ami-queretaro"
  settings    Json?    // Configuraciones globales
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  // Relaciones
  clinics     Clinic[]
  companies   Company[]
  users       User[]
  services    Service[]
  batteries   Battery[]
}
```

### 2. CLINIC (Cl√≠nicas/Sedes)

```prisma
model Clinic {
  id          String   @id @default(cuid())
  tenantId    String
  name        String   // "AMI Centro"
  address     String
  phone       String?
  email       String?
  timezone    String   @default("America/Mexico_City")
  maxPatientsPerDay Int @default(60)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  // Relaciones
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  schedules   ClinicSchedule[]
  services    ClinicService[]
  blockedDates ClinicBlockedDate[]
  appointments Appointment[]
  
  @@index([tenantId])
}

model ClinicSchedule {
  id              String   @id @default(cuid())
  clinicId        String
  dayOfWeek       Int      // 1=Lunes, 7=Domingo
  openTime        String   // "07:00"
  closeTime       String   // "19:00"
  slotDuration    Int      @default(30) // minutos
  maxPatientsPerSlot Int   @default(4)
  
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  
  @@unique([clinicId, dayOfWeek])
}

model ClinicService {
  id          String   @id @default(cuid())
  clinicId    String
  serviceId   String
  isAvailable Boolean  @default(true)
  notes       String?
  
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
  service     Service  @relation(fields: [serviceId], references: [id])
  
  @@unique([clinicId, serviceId])
}

model ClinicBlockedDate {
  id          String   @id @default(cuid())
  clinicId    String
  date        DateTime
  reason      String?  // "D√≠a festivo", "Mantenimiento"
  blockedBy   String?
  
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
  
  @@index([clinicId, date])
}
```

### 3. SERVICE & BATTERY (Cat√°logo de Servicios)

```prisma
model Service {
  id              String   @id @default(cuid())
  tenantId        String
  code            String   // "LAB_BH", "GAB_ESPIRO"
  name            String   // "Biometr√≠a Hem√°tica"
  category        ServiceCategory
  durationMinutes Int      @default(15)
  requiresEquipment String? // "Espir√≥metro"
  requiresFasting Boolean  @default(false)
  basePrice       Decimal? @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  clinicServices  ClinicService[]
  batteryItems    BatteryItem[]
  studies         Study[]
  
  @@unique([tenantId, code])
  @@index([tenantId])
}

enum ServiceCategory {
  LABORATORIO
  GABINETE
  IMAGEN
  CONSULTORIO
}

model Battery {
  id              String   @id @default(cuid())
  tenantId        String
  name            String   // "Paquete Farmac√©utico"
  description     String?
  isTemplate      Boolean  @default(true) // true=global, false=espec√≠fica empresa
  companyId       String?  // null si es template
  totalDuration   Int?     // calculado
  packagePrice    Decimal? @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  company         Company? @relation(fields: [companyId], references: [id])
  items           BatteryItem[]
  companyBatteries CompanyBattery[]
  jobProfiles     JobProfile[]
  appointments    Appointment[]
  
  @@index([tenantId])
}

model BatteryItem {
  id          String   @id @default(cuid())
  batteryId   String
  serviceId   String
  isOptional  Boolean  @default(false)
  
  battery     Battery  @relation(fields: [batteryId], references: [id])
  service     Service  @relation(fields: [serviceId], references: [id])
  
  @@unique([batteryId, serviceId])
}
```

### 4. COMPANY (Empresas Cliente)

```prisma
model Company {
  id              String   @id @default(cuid())
  tenantId        String
  name            String   // "ABBOTT MEDICAL MEXICO"
  rfc             String?
  sector          String?  // "Farmac√©utica"
  address         String?
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  deliveryConfig  Json?    // {electronic: true, timeHours: 24, format: "PDF"}
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  batteries       Battery[] // Bater√≠as personalizadas
  companyBatteries CompanyBattery[]
  jobProfiles     JobProfile[]
  patients        Patient[]
  appointments    Appointment[]
  
  @@index([tenantId])
}

model CompanyBattery {
  id          String   @id @default(cuid())
  companyId   String
  batteryId   String
  customPrice Decimal? @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  validFrom   DateTime?
  validUntil  DateTime?
  
  company     Company  @relation(fields: [companyId], references: [id])
  battery     Battery  @relation(fields: [batteryId], references: [id])
  
  @@unique([companyId, batteryId])
}

model JobProfile {
  id              String   @id @default(cuid())
  companyId       String
  name            String   // "Operador Producci√≥n"
  defaultBatteryId String?
  riskLevel       RiskLevel @default(MEDIO)
  worksAtHeight   Boolean  @default(false)
  handlesFood     Boolean  @default(false)
  drivesVehicles  Boolean  @default(false)
  isActive        Boolean  @default(true)
  notes           String?
  
  company         Company  @relation(fields: [companyId], references: [id])
  defaultBattery  Battery? @relation(fields: [defaultBatteryId], references: [id])
  patients        Patient[]
  
  @@index([companyId])
}

enum RiskLevel {
  BAJO
  MEDIO
  ALTO
}
```

### 5. PATIENT (Pacientes)

```prisma
model Patient {
  id              String   @id @default(cuid())
  tenantId        String
  companyId       String
  jobProfileId    String?
  
  // Identificaci√≥n
  amiId           String   @unique // "GARA850101M-AMI-CLI"
  curp            String?
  rfc             String?
  
  // Datos personales
  firstName       String
  lastName        String
  birthDate       DateTime
  sex             Sex
  phone           String?
  email           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  company         Company  @relation(fields: [companyId], references: [id])
  jobProfile      JobProfile? @relation(fields: [jobProfileId], references: [id])
  appointments    Appointment[]
  expedientes     Expediente[]
  
  @@index([tenantId])
  @@index([companyId])
}

enum Sex {
  M
  F
}
```

### 6. APPOINTMENT (Citas)

```prisma
model Appointment {
  id              String   @id @default(cuid())
  tenantId        String
  patientId       String
  clinicId        String
  companyId       String
  batteryId       String?
  
  examType        ExamType
  scheduledDate   DateTime
  scheduledTime   String   // "09:00"
  status          AppointmentStatus @default(SCHEDULED)
  
  confirmationSentAt DateTime?
  reminderSentAt    DateTime?
  arrivedAt         DateTime?
  
  createdBy       String?
  notes           String?
  createdAt       DateTime @default(now())
  
  patient         Patient  @relation(fields: [patientId], references: [id])
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  company         Company  @relation(fields: [companyId], references: [id])
  battery         Battery? @relation(fields: [batteryId], references: [id])
  expediente      Expediente?
  
  @@index([tenantId])
  @@index([clinicId, scheduledDate])
  @@index([patientId])
}

enum ExamType {
  INGRESO
  PERIODICO
  EGRESO
  ESPECIAL
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}
```

### 7. EXPEDIENTE (Flujo M√©dico)

```prisma
model Expediente {
  id              String   @id @default(cuid())
  tenantId        String
  patientId       String
  appointmentId   String?  @unique
  
  folio           String   @unique // "RD-2026-001"
  status          ExpedienteStatus @default(RECEPCION)
  
  createdAt       DateTime @default(now())
  completedAt     DateTime?
  tatHours        Float?   // Time-to-Aptitude
  
  patient         Patient  @relation(fields: [patientId], references: [id])
  appointment     Appointment? @relation(fields: [appointmentId], references: [id])
  examResult      ExamResult?
  studies         Study[]
  dictamen        Dictamen?
  auditLogs       AuditLog[]
  
  @@index([tenantId])
  @@index([patientId])
}

enum ExpedienteStatus {
  RECEPCION
  EXAMEN_MEDICO
  ESTUDIOS
  VALIDACION
  COMPLETADO
  CANCELADO
}

model ExamResult {
  id              String   @id @default(cuid())
  expedienteId    String   @unique
  
  // Signos vitales
  bloodPressureSys Int?    // Sist√≥lica
  bloodPressureDia Int?    // Diast√≥lica
  heartRate       Int?     // FC
  respRate        Int?     // FR
  temperature     Float?
  weight          Float?   // kg
  height          Float?   // m
  bmi             Float?   // Calculado
  
  // Agudeza visual
  visualAcuityOD  String?  // "20/20"
  visualAcuityOI  String?
  usesCorrectiveLenses Boolean @default(false)
  
  // Aptitud inicial
  initialAptitude Aptitude?
  observations    String?
  
  examinedBy      String?  // userId del m√©dico
  examinedAt      DateTime?
  
  expediente      Expediente @relation(fields: [expedienteId], references: [id])
}

enum Aptitude {
  APTO
  APTO_CON_RESTRICCIONES
  NO_APTO
  PENDIENTE
}
```

### 8. STUDY & EXTRACTED_DATA (Estudios con IA)

```prisma
model Study {
  id              String   @id @default(cuid())
  expedienteId    String
  serviceId       String
  
  storageUrl      String?  // URL en GCP Storage
  originalFileName String?
  
  status          StudyStatus @default(PENDING)
  aiConfidence    Float?   // 0-100
  processedAt     DateTime?
  
  createdAt       DateTime @default(now())
  
  expediente      Expediente @relation(fields: [expedienteId], references: [id])
  service         Service  @relation(fields: [serviceId], references: [id])
  extractedData   ExtractedData[]
  
  @@index([expedienteId])
}

enum StudyStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
  VALIDATED
}

model ExtractedData {
  id              String   @id @default(cuid())
  studyId         String
  
  fieldCode       String   // "hemoglobin", "fvc_percent"
  fieldName       String   // "Hemoglobina"
  value           String   // "13.5"
  unit            String?  // "g/dL"
  
  referenceMin    Float?
  referenceMax    Float?
  
  semaphore       Semaphore? // üî¥üü°üü¢
  confidence      Float?   // Confianza de la extracci√≥n
  
  isOverridden    Boolean  @default(false) // M√©dico corrigi√≥
  overriddenValue String?
  overriddenBy    String?
  
  study           Study    @relation(fields: [studyId], references: [id])
  
  @@index([studyId])
}

enum Semaphore {
  CRITICAL    // üî¥
  WARNING     // üü°
  NORMAL      // üü¢
}
```

### 9. DICTAMEN (Validaci√≥n M√©dica)

```prisma
model Dictamen {
  id              String   @id @default(cuid())
  expedienteId    String   @unique
  
  resultado       Aptitude
  restricciones   Json?    // ["No cargas >10kg", "Uso de lentes"]
  recomendaciones Json?    // ["Ejercicios respiratorios"]
  observaciones   String?
  
  // Sugerencia IA
  aiSuggestedResult Aptitude?
  aiConfidence    Float?
  
  // Firma m√©dico
  validatedBy     String   // userId del m√©dico validador
  validatedAt     DateTime
  signatureUrl    String?  // URL de firma digital
  
  expediente      Expediente @relation(fields: [expedienteId], references: [id])
}
```

### 10. USER & AUTH

```prisma
model User {
  id              String   @id @default(cuid())
  tenantId        String
  
  email           String   @unique
  name            String
  role            UserRole
  
  // Para m√©dicos
  professionalId  String?  // C√©dula profesional
  signatureUrl    String?  // Firma √∫nica generada
  
  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime @default(now())
  
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  auditLogs       AuditLog[]
  
  @@index([tenantId])
}

enum UserRole {
  ADMIN
  COORDINADOR
  MEDICO_VALIDADOR
  MEDICO_EXAMINADOR
  TECNICO
  RECEPCIONISTA
  EMPRESA_RH  // Portal empresas
}
```

### 11. AUDIT_LOG (Bit√°cora)

```prisma
model AuditLog {
  id              String   @id @default(cuid())
  tenantId        String
  
  userId          String?
  expedienteId    String?
  
  action          AuditAction
  entityType      String   // "Expediente", "Study", "Dictamen"
  entityId        String
  
  changes         Json?    // {field: {old: X, new: Y}}
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime @default(now())
  
  user            User?    @relation(fields: [userId], references: [id])
  expediente      Expediente? @relation(fields: [expedienteId], references: [id])
  
  @@index([tenantId])
  @@index([expedienteId])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  SIGN
  SEND
  LOGIN
  LOGOUT
}
```

---

## Multi-tenancy Strategy

Todas las queries incluyen `tenantId` autom√°ticamente via Prisma middleware:

```typescript
prisma.$use(async (params, next) => {
  const tenantId = getCurrentTenantId();
  
  if (params.action === 'findMany' || params.action === 'findFirst') {
    params.args.where = {
      ...params.args.where,
      tenantId
    };
  }
  
  if (params.action === 'create') {
    params.args.data.tenantId = tenantId;
  }
  
  return next(params);
});
```

---

## Referencias

- [ARCH-20260112-01](ADR-ARCH-20260112-01.md) - Arquitectura Modular
- [ARCH-20260112-02](ADR-ARCH-20260112-02.md) - Stack Tecnol√≥gico
- Legacy: `context/LEGACY_IMPORT/ami-rd/context/AMI a Residente Digital/`

---

**üèóÔ∏è ARCH REFERENCE:** ARCH-20260112-03  
**ü§ñ AUTHOR:** INTEGRA (Arquitecto IA)
